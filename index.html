<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gest√£o Financeira Inteligente - Gordinho do Comfort</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN (ok para GitHub Pages, ignore o aviso em amarelo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js para gr√°fico de evolu√ß√£o -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-slate-900 border-b border-slate-800">
    <div class="max-w-5xl mx-auto flex items-center justify-between px-4 sm:px-6 py-3">
      <div class="flex items-center gap-3">
        <img
          src="https://raw.githubusercontent.com/eduardoeff/gestao-financeira-motorista/main/logo-gordinho-comfort.png"
          alt="Logo Gordinho do Comfort"
          class="w-10 h-10 sm:w-12 sm:h-12 rounded-full border border-emerald-400 shadow-lg object-cover"
        />
        <div>
          <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-emerald-400">
            Gest√£o Financeira Inteligente
          </h1>
          <p class="text-xs sm:text-sm text-slate-400">
            Gordinho do Comfort ‚Ä¢ Controle total dos ganhos e despesas
          </p>
        </div>
      </div>

      <button
        id="logoutBtn"
        class="hidden sm:inline-flex px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-800 text-slate-100 border border-slate-700 hover:border-emerald-400 hover:text-emerald-400 transition"
      >
        Sair
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6">

      <!-- CARD LOGIN -->
      <section id="authSection" class="max-w-md mx-auto mt-8 sm:mt-12">
        <div class="bg-slate-900/80 border border-slate-800 rounded-2xl shadow-xl p-6 sm:p-8">
          <h2 class="text-xl sm:text-2xl font-semibold text-center mb-1">
            Entrar
          </h2>
          <p class="text-xs sm:text-sm text-slate-400 text-center mb-4">
            Acesse seu painel financeiro do <span class="text-emerald-400 font-semibold">Gordinho do Comfort</span>
          </p>

          <label class="block text-xs sm:text-sm text-slate-300 mb-1">E-mail</label>
          <input
            id="emailInput"
            type="email"
            class="w-full mb-3 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm focus:outline-none focus:border-emerald-400"
            placeholder="seuemail@exemplo.com"
          />

          <label class="block text-xs sm:text-sm text-slate-300 mb-1">Senha</label>
          <input
            id="passwordInput"
            type="password"
            class="w-full mb-4 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm focus:outline-none focus:border-emerald-400"
            placeholder="********"
          />

          <button
            id="loginBtn"
            class="w-full mb-2 px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold text-sm transition"
          >
            Entrar
          </button>
          <button
            id="registerBtn"
            class="w-full px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100 text-sm border border-slate-700"
          >
            Criar Conta
          </button>
        </div>
      </section>

      <!-- APP PRINCIPAL -->
      <section id="appSection" class="hidden mt-4 sm:mt-6">
        <!-- NAV TABS -->
        <nav class="flex flex-wrap gap-2 mb-4">
          <button data-tab="dashboard" class="tab-btn px-3 py-1.5 rounded-full border border-emerald-400 bg-emerald-500/20 text-xs sm:text-sm font-medium text-emerald-300">
            üìä Dashboard
          </button>
          <button data-tab="earnings" class="tab-btn px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-xs sm:text-sm font-medium text-slate-200">
            üí∞ Ganhos
          </button>
          <button data-tab="goals" class="tab-btn px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-xs sm:text-sm font-medium text-slate-200">
            üéØ Metas
          </button>
          <button data-tab="work" class="tab-btn px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-xs sm:text-sm font-medium text-slate-200">
            üöó Trabalho
          </button>
          <button data-tab="home" class="tab-btn px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-xs sm:text-sm font-medium text-slate-200">
            üè† Casa
          </button>

          <button
            id="logoutBtnMobile"
            class="ml-auto sm:hidden px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-xs font-medium text-slate-200"
          >
            Sair
          </button>
        </nav>

        <!-- DASHBOARD -->
        <section id="tab-dashboard" class="tab-panel">
          <!-- Filtro de per√≠odo -->
          <div class="flex flex-wrap items-center gap-2 mb-4">
            <span class="text-xs sm:text-sm text-slate-400 mr-2">Per√≠odo:</span>
            <button class="period-btn period-active" data-period="last7">√öltima Semana</button>
            <button class="period-btn" data-period="month">M√™s Atual</button>
            <button class="period-btn" data-period="year">Ano Atual</button>
            <button class="period-btn" data-period="prevMonth">M√™s Anterior</button>
          </div>

          <!-- Cards principais -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <div class="card">
              <p class="card-label">Ganhos</p>
              <p id="totalEarningsDisplay" class="card-value">R$ 0,00</p>
            </div>
            <div class="card">
              <p class="card-label">Despesas Trabalho</p>
              <p id="totalWorkExpensesDisplay" class="card-value">R$ 0,00</p>
            </div>
            <div class="card">
              <p class="card-label">Despesas Casa</p>
              <p id="totalHouseExpensesDisplay" class="card-value">R$ 0,00</p>
            </div>
            <div class="card">
              <p class="card-label">Lucro</p>
              <p id="profitDisplay" class="card-value text-emerald-400">R$ 0,00</p>
            </div>
            <div class="card">
              <p class="card-label">Saldo Final (ap√≥s Casa)</p>
              <p id="finalBalanceDisplay" class="card-value">R$ 0,00</p>
            </div>
          </div>

          <!-- Indicadores de efici√™ncia -->
          <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5 mb-4">
            <h3 class="text-sm sm:text-base font-semibold mb-3 text-emerald-300">
              üìà Indicadores de Efici√™ncia
            </h3>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <div>
                <p class="text-xs text-slate-400 mb-1">Ticket M√©dio</p>
                <p id="avgTicketDisplay" class="text-lg font-semibold">R$ 0,00</p>
              </div>
              <div>
                <p class="text-xs text-slate-400 mb-1">Custo/Dia</p>
                <p id="costPerDayDisplay" class="text-lg font-semibold">R$ 0,00</p>
              </div>
              <div>
                <p class="text-xs text-slate-400 mb-1">Margem</p>
                <p id="marginDisplay" class="text-lg font-semibold">0%</p>
              </div>
              <div>
                <p class="text-xs text-slate-400 mb-1">Meta Di√°ria Atual</p>
                <p id="currentDailyGoalDisplay" class="text-lg font-semibold text-emerald-400">
                  R$ 0,00
                </p>
              </div>
            </div>
          </div>

          <!-- Gr√°fico -->
          <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm sm:text-base font-semibold text-emerald-300">
                üìä Evolu√ß√£o dos Ganhos (M√™s Completo)
              </h3>
            </div>
            <canvas id="earningsChart" class="w-full h-48 sm:h-64"></canvas>
          </div>
        </section>

        <!-- GANHOS -->
        <section id="tab-earnings" class="tab-panel hidden">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm sm:text-base font-semibold text-emerald-300">
              üí∞ Ganhos Di√°rios
            </h3>
            <button
              id="openEarningsModalBtn"
              class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium bg-emerald-500 text-slate-950 hover:bg-emerald-400"
            >
              + Adicionar Ganho do Dia
            </button>
          </div>
          <p class="text-xs text-slate-400 mb-2">
            Os ganhos salvos aqui alimentam o dashboard, indicadores e metas.
          </p>
          <ul id="earningsList" class="space-y-2 text-xs sm:text-sm">
            <!-- preenchido via JS -->
          </ul>
        </section>

        <!-- METAS -->
        <section id="tab-goals" class="tab-panel hidden space-y-4">
          <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5">
            <h3 class="text-sm sm:text-base font-semibold text-emerald-300 mb-3">
              üéØ Meta Mensal
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
              <div>
                <label class="label">M√™s</label>
                <input
                  id="monthlyGoalMonth"
                  type="month"
                  class="input"
                />
              </div>
              <div>
                <label class="label">Valor da Meta (R$)</label>
                <input
                  id="monthlyGoalValue"
                  type="number"
                  min="0"
                  step="0.01"
                  class="input"
                  placeholder="ex: 6000"
                />
              </div>
              <div class="flex gap-2">
                <button
                  id="saveMonthlyGoalBtn"
                  class="btn-primary flex-1"
                >
                  Salvar Meta Mensal
                </button>
              </div>
            </div>
          </div>

          <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5">
            <h3 class="text-sm sm:text-base font-semibold text-emerald-300 mb-3">
              üéØ Meta Semanal
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 items-end">
              <div>
                <label class="label">M√™s</label>
                <input
                  id="weeklyGoalMonth"
                  type="month"
                  class="input"
                />
              </div>
              <div>
                <label class="label">Semanas</label>
                <select id="weeklyGoalWeeks" class="input" multiple>
                  <option value="1">Semana 1</option>
                  <option value="2">Semana 2</option>
                  <option value="3">Semana 3</option>
                  <option value="4">Semana 4</option>
                  <option value="5">Semana 5</option>
                </select>
                <p class="text-[10px] text-slate-500 mt-1">
                  Use Ctrl (ou Command) para selecionar v√°rias semanas.
                </p>
              </div>
              <div>
                <label class="label">Valor da Meta (R$)</label>
                <input
                  id="weeklyGoalValue"
                  type="number"
                  min="0"
                  step="0.01"
                  class="input"
                  placeholder="ex: 1500"
                />
              </div>
              <div class="flex gap-2">
                <button
                  id="saveWeeklyGoalBtn"
                  class="btn-primary flex-1"
                >
                  Salvar Meta Semanal
                </button>
              </div>
            </div>
          </div>

          <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5 flex flex-col sm:flex-row items-start sm:items-center gap-3">
            <div class="flex-1">
              <p class="text-xs text-slate-400 mb-1">Meta Di√°ria Atual</p>
              <p id="goalsCurrentDailyDisplay" class="text-xl font-semibold text-emerald-400">
                R$ 0,00
              </p>
              <p class="text-[10px] text-slate-500 mt-1">
                Calculada automaticamente com base na meta mensal/semanal selecionada para o m√™s atual.
              </p>
            </div>
            <button
              id="clearGoalsBtn"
              class="px-3 py-1.5 rounded-lg border border-red-500/70 text-xs sm:text-sm text-red-300 hover:bg-red-500/10"
            >
              Limpar Metas
            </button>
          </div>
        </section>

        <!-- TRABALHO -->
        <section id="tab-work" class="tab-panel hidden">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm sm:text-base font-semibold text-emerald-300">
              üöó Despesas de Trabalho
            </h3>
            <button
              id="openWorkExpenseModalBtn"
              class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium bg-emerald-500 text-slate-950 hover:bg-emerald-400"
            >
              + Adicionar Despesa
            </button>
          </div>
          <ul id="workExpensesList" class="space-y-2 text-xs sm:text-sm">
            <!-- preenchido via JS -->
          </ul>
        </section>

        <!-- CASA -->
        <section id="tab-home" class="tab-panel hidden">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm sm:text-base font-semibold text-emerald-300">
              üè† Despesas de Casa
            </h3>
            <button
              id="openHouseExpenseModalBtn"
              class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium bg-emerald-500 text-slate-950 hover:bg-emerald-400"
            >
              + Adicionar Despesa
            </button>
          </div>
          <ul id="houseExpensesList" class="space-y-2 text-xs sm:text-sm">
            <!-- preenchido via JS -->
          </ul>
        </section>
      </section>
    </div>
  </main>

  <!-- MODAL GANHOS -->
  <div id="earningsModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-40 hidden">
    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 w-full max-w-md mx-4">
      <h3 class="text-sm sm:text-base font-semibold text-emerald-300 mb-3">
        üí∞ Adicionar Ganho do Dia
      </h3>

      <label class="label">Data</label>
      <input id="earningsDate" type="date" class="input mb-2" />

      <label class="label">Plataforma</label>
      <select id="earningsPlatform" class="input mb-2">
        <option value="Uber">Uber</option>
        <option value="99">99</option>
        <option value="InDriver">InDriver</option>
        <option value="Outros">Outros</option>
      </select>

      <label class="label">Valor (R$)</label>
      <input id="earningsAmount" type="number" min="0" step="0.01" class="input mb-2" />

      <label class="label">Observa√ß√µes (opcional)</label>
      <textarea id="earningsNotes" rows="2" class="input mb-4"></textarea>

      <div class="flex justify-end gap-2">
        <button id="cancelEarningsBtn" class="btn-secondary">Cancelar</button>
        <button id="saveEarningsBtn" class="btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DESPESA TRABALHO -->
  <div id="workExpenseModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-40 hidden">
    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 w-full max-w-md mx-4">
      <h3 class="text-sm sm:text-base font-semibold text-emerald-300 mb-3">
        üöó Adicionar Despesa de Trabalho
      </h3>

      <label class="label">Data</label>
      <input id="workExpenseDate" type="date" class="input mb-2" />

      <label class="label">Categoria</label>
      <select id="workExpenseCategory" class="input mb-2">
        <option value="Combust√≠vel">Combust√≠vel</option>
        <option value="Manuten√ß√£o">Manuten√ß√£o</option>
        <option value="Lavagem">Lavagem</option>
        <option value="Ped√°gio">Ped√°gio</option>
        <option value="Estacionamento">Estacionamento</option>
        <option value="Outros">Outros</option>
      </select>

      <label class="label">Valor (R$)</label>
      <input id="workExpenseAmount" type="number" min="0" step="0.01" class="input mb-2" />

      <label class="label">Descri√ß√£o (opcional)</label>
      <textarea id="workExpenseDescription" rows="2" class="input mb-4"></textarea>

      <div class="flex justify-end gap-2">
        <button id="cancelWorkExpenseBtn" class="btn-secondary">Cancelar</button>
        <button id="saveWorkExpenseBtn" class="btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DESPESA CASA -->
  <div id="houseExpenseModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-40 hidden">
    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 w-full max-w-md mx-4">
      <h3 class="text-sm sm:text-base font-semibold text-emerald-300 mb-3">
        üè† Adicionar Despesa de Casa
      </h3>

      <label class="label">Data</label>
      <input id="houseExpenseDate" type="date" class="input mb-2" />

      <label class="label">Categoria</label>
      <select id="houseExpenseCategory" class="input mb-2">
        <option value="Aluguel">Aluguel</option>
        <option value="√Ågua">√Ågua</option>
        <option value="Luz">Luz</option>
        <option value="Internet">Internet</option>
        <option value="Mercado">Mercado</option>
        <option value="Outros">Outros</option>
      </select>

      <label class="label">Valor (R$)</label>
      <input id="houseExpenseAmount" type="number" min="0" step="0.01" class="input mb-2" />

      <label class="label">Descri√ß√£o (opcional)</label>
      <textarea id="houseExpenseDescription" rows="2" class="input mb-4"></textarea>

      <div class="flex justify-end gap-2">
        <button id="cancelHouseExpenseBtn" class="btn-secondary">Cancelar</button>
        <button id="saveHouseExpenseBtn" class="btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- ESTILOS UTILIT√ÅRIOS -->
  <style>
    .card {
      @apply bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5;
    }
    .card-label {
      @apply text-xs text-slate-400 mb-1;
    }
    .card-value {
      @apply text-xl sm:text-2xl font-semibold;
    }
    .label {
      @apply block text-xs text-slate-300 mb-1;
    }
    .input {
      @apply w-full rounded-lg bg-slate-800 border border-slate-700 text-sm px-3 py-2 text-slate-100 focus:outline-none focus:border-emerald-400;
    }
    .btn-primary {
      @apply px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-950 text-xs sm:text-sm font-semibold hover:bg-emerald-400 transition;
    }
    .btn-secondary {
      @apply px-3 py-1.5 rounded-lg bg-slate-800 text-slate-100 text-xs sm:text-sm border border-slate-700 hover:bg-slate-700 transition;
    }
    .period-btn {
      @apply px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-xs sm:text-sm text-slate-200;
    }
    .period-active {
      @apply border-emerald-400 text-emerald-300 bg-emerald-500/10;
    }
  </style>

  <!-- FIREBASE + L√ìGICA DO APP -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      setDoc,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      orderBy,
      serverTimestamp,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // üîê CONFIG FIREBASE - PREENCHA COM OS DADOS DO SEU PROJETO
    const firebaseConfig = {
      apiKey: "AIzaSyDWMlDtQ1dhvE3mLYhRakJ1oM8TJyJd6s8",
      authDomain: "gestao-motorista-4155f.firebaseapp.com",
      projectId: "gestao-motorista-4155f",
      storageBucket: "gestao-motorista-4155f.appspot.com",
      messagingSenderId: "566057933394",
      appId: "1:566057933394:web:afafa56f71557758b11d8b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- HELPERS ----------
    const safeNumber = (value) => {
      const n = Number(value);
      return isNaN(n) ? 0 : n;
    };

    const formatCurrency = (value) => {
      const n = safeNumber(value);
      return "R$ " + n.toFixed(2).replace(".", ",");
    };

    const formatPercent = (value) => {
      const n = safeNumber(value);
      return n.toFixed(1).replace(".", ",") + "%";
    };

    const todayISO = () => new Date().toISOString().split("T")[0];

    // ---------- ELEMENTOS ----------
    const authSection = document.getElementById("authSection");
    const appSection = document.getElementById("appSection");
    const logoutBtn = document.getElementById("logoutBtn");
    const logoutBtnMobile = document.getElementById("logoutBtnMobile");

    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");

    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanels = {
      dashboard: document.getElementById("tab-dashboard"),
      earnings: document.getElementById("tab-earnings"),
      goals: document.getElementById("tab-goals"),
      work: document.getElementById("tab-work"),
      home: document.getElementById("tab-home")
    };

    // Dashboard displays
    const totalEarningsDisplay = document.getElementById("totalEarningsDisplay");
    const totalWorkExpensesDisplay = document.getElementById("totalWorkExpensesDisplay");
    const totalHouseExpensesDisplay = document.getElementById("totalHouseExpensesDisplay");
    const profitDisplay = document.getElementById("profitDisplay");
    const finalBalanceDisplay = document.getElementById("finalBalanceDisplay");
    const avgTicketDisplay = document.getElementById("avgTicketDisplay");
    const costPerDayDisplay = document.getElementById("costPerDayDisplay");
    const marginDisplay = document.getElementById("marginDisplay");
    const currentDailyGoalDisplay = document.getElementById("currentDailyGoalDisplay");

    // Metas
    const monthlyGoalMonth = document.getElementById("monthlyGoalMonth");
    const monthlyGoalValue = document.getElementById("monthlyGoalValue");
    const weeklyGoalMonth = document.getElementById("weeklyGoalMonth");
    const weeklyGoalWeeks = document.getElementById("weeklyGoalWeeks");
    const weeklyGoalValue = document.getElementById("weeklyGoalValue");
    const goalsCurrentDailyDisplay = document.getElementById("goalsCurrentDailyDisplay");

    // Lists
    const earningsList = document.getElementById("earningsList");
    const workExpensesList = document.getElementById("workExpensesList");
    const houseExpensesList = document.getElementById("houseExpensesList");

    // Period buttons
    const periodButtons = document.querySelectorAll(".period-btn");

    // Modals
    const earningsModal = document.getElementById("earningsModal");
    const earningsDate = document.getElementById("earningsDate");
    const earningsPlatform = document.getElementById("earningsPlatform");
    const earningsAmount = document.getElementById("earningsAmount");
    const earningsNotes = document.getElementById("earningsNotes");
    const openEarningsModalBtn = document.getElementById("openEarningsModalBtn");
    const saveEarningsBtn = document.getElementById("saveEarningsBtn");
    const cancelEarningsBtn = document.getElementById("cancelEarningsBtn");

    const workExpenseModal = document.getElementById("workExpenseModal");
    const workExpenseDate = document.getElementById("workExpenseDate");
    const workExpenseCategory = document.getElementById("workExpenseCategory");
    const workExpenseAmount = document.getElementById("workExpenseAmount");
    const workExpenseDescription = document.getElementById("workExpenseDescription");
    const openWorkExpenseModalBtn = document.getElementById("openWorkExpenseModalBtn");
    const saveWorkExpenseBtn = document.getElementById("saveWorkExpenseBtn");
    const cancelWorkExpenseBtn = document.getElementById("cancelWorkExpenseBtn");

    const houseExpenseModal = document.getElementById("houseExpenseModal");
    const houseExpenseDate = document.getElementById("houseExpenseDate");
    const houseExpenseCategory = document.getElementById("houseExpenseCategory");
    const houseExpenseAmount = document.getElementById("houseExpenseAmount");
    const houseExpenseDescription = document.getElementById("houseExpenseDescription");
    const openHouseExpenseModalBtn = document.getElementById("openHouseExpenseModalBtn");
    const saveHouseExpenseBtn = document.getElementById("saveHouseExpenseBtn");
    const cancelHouseExpenseBtn = document.getElementById("cancelHouseExpenseBtn");

    const saveMonthlyGoalBtn = document.getElementById("saveMonthlyGoalBtn");
    const saveWeeklyGoalBtn = document.getElementById("saveWeeklyGoalBtn");
    const clearGoalsBtn = document.getElementById("clearGoalsBtn");

    // ---------- AUTENTICA√á√ÉO ----------
    loginBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        alert("Informe e-mail e senha.");
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        console.error("Erro ao entrar:", error);
        alert("Erro ao entrar: " + (error.message || "Verifique e-mail e senha."));
      }
    });

    registerBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        alert("Informe e-mail e senha.");
        return;
      }
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("Conta criada com sucesso!");
      } catch (error) {
        console.error("Erro ao criar conta:", error);
        alert("Erro ao criar conta: " + (error.message || ""));
      }
    });

    const doLogout = async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error("Erro ao sair:", error);
      }
    };

    logoutBtn.addEventListener("click", doLogout);
    logoutBtnMobile.addEventListener("click", doLogout);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        initForUser(user);
      } else {
        authSection.classList.remove("hidden");
        appSection.classList.add("hidden");
      }
    });

    // ---------- TABS ----------
    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        tabButtons.forEach((b) =>
          b.classList.remove("border-emerald-400", "bg-emerald-500/20", "text-emerald-300")
        );
        btn.classList.add("border-emerald-400", "bg-emerald-500/20", "text-emerald-300");

        Object.entries(tabPanels).forEach(([key, panel]) => {
          panel.classList.toggle("hidden", key !== tab);
        });
      });
    });

    // ---------- MODAIS ----------
    const openModal = (el) => el.classList.remove("hidden");
    const closeModal = (el) => el.classList.add("hidden");

    openEarningsModalBtn?.addEventListener("click", () => {
      earningsDate.value = todayISO();
      earningsAmount.value = "";
      earningsNotes.value = "";
      openModal(earningsModal);
    });
    cancelEarningsBtn?.addEventListener("click", () => closeModal(earningsModal));

    openWorkExpenseModalBtn?.addEventListener("click", () => {
      workExpenseDate.value = todayISO();
      workExpenseAmount.value = "";
      workExpenseDescription.value = "";
      openModal(workExpenseModal);
    });
    cancelWorkExpenseBtn?.addEventListener("click", () => closeModal(workExpenseModal));

    openHouseExpenseModalBtn?.addEventListener("click", () => {
      houseExpenseDate.value = todayISO();
      houseExpenseAmount.value = "";
      houseExpenseDescription.value = "";
      openModal(houseExpenseModal);
    });
    cancelHouseExpenseBtn?.addEventListener("click", () => closeModal(houseExpenseModal));

    // ---------- SALVAR GANHOS ----------
    saveEarningsBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) {
        alert("Voc√™ precisa estar logado.");
        return;
      }
      const date = earningsDate.value;
      const platform = earningsPlatform.value;
      const amount = safeNumber(earningsAmount.value);
      const notes = earningsNotes.value || "";

      if (!date || amount <= 0) {
        alert("Informe uma data e um valor maior que zero.");
        return;
      }

      try {
        await addDoc(collection(db, "dailyEarnings"), {
          userId: user.uid,
          date,
          platform,
          amount,
          notes,
          createdAt: serverTimestamp()
        });
        closeModal(earningsModal);
        await loadAllData(user);
      } catch (error) {
        console.error("Erro ao salvar ganhos:", error);
        alert("Erro ao salvar ganhos. Veja o console.");
      }
    });

    // ---------- SALVAR DESPESAS ----------
    saveWorkExpenseBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const date = workExpenseDate.value;
      const category = workExpenseCategory.value;
      const amount = safeNumber(workExpenseAmount.value);
      const description = workExpenseDescription.value || "";

      if (!date || amount <= 0) {
        alert("Informe data e valor.");
        return;
      }

      try {
        await addDoc(collection(db, "expenses"), {
          userId: user.uid,
          date,
          category,
          amount,
          description,
          type: "work",
          createdAt: serverTimestamp()
        });
        closeModal(workExpenseModal);
        await loadAllData(user);
      } catch (error) {
        console.error("Erro ao salvar despesa de trabalho:", error);
        alert("Erro ao salvar. Veja o console.");
      }
    });

    saveHouseExpenseBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const date = houseExpenseDate.value;
      const category = houseExpenseCategory.value;
      const amount = safeNumber(houseExpenseAmount.value);
      const description = houseExpenseDescription.value || "";

      if (!date || amount <= 0) {
        alert("Informe data e valor.");
        return;
      }

      try {
        await addDoc(collection(db, "houseExpenses"), {
          userId: user.uid,
          date,
          category,
          amount,
          description,
          createdAt: serverTimestamp()
        });
        closeModal(houseExpenseModal);
        await loadAllData(user);
      } catch (error) {
        console.error("Erro ao salvar despesa de casa:", error);
        alert("Erro ao salvar. Veja o console.");
      }
    });

    // ---------- METAS ----------
    const goalsDocRef = (uid) => doc(db, "userGoals", uid);

    saveMonthlyGoalBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const month = monthlyGoalMonth.value; // yyyy-mm
      const value = safeNumber(monthlyGoalValue.value);

      if (!month || value <= 0) {
        alert("Informe m√™s e valor da meta.");
        return;
      }

      try {
        const ref = goalsDocRef(user.uid);
        const snap = await getDoc(ref);
        const data = snap.exists() ? snap.data() : {};
        const monthlyGoals = data.monthlyGoals || {};
        monthlyGoals[month] = value;

        await setDoc(ref, { ...data, monthlyGoals }, { merge: true });
        await loadGoals(user);
        alert("Meta mensal salva.");
      } catch (error) {
        console.error("Erro ao salvar meta mensal:", error);
        alert("Erro ao salvar meta mensal.");
      }
    });

    saveWeeklyGoalBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const month = weeklyGoalMonth.value;
      const value = safeNumber(weeklyGoalValue.value);
      const selectedWeeks = Array.from(weeklyGoalWeeks.selectedOptions).map((o) =>
        Number(o.value)
      );

      if (!month || value <= 0 || selectedWeeks.length === 0) {
        alert("Informe m√™s, semanas e valor.");
        return;
      }

      try {
        const ref = goalsDocRef(user.uid);
        const snap = await getDoc(ref);
        const data = snap.exists() ? snap.data() : {};
        const weeklyGoals = data.weeklyGoals || {};

        const key = `${month}-${selectedWeeks.join(",")}`;
        weeklyGoals[key] = { value, weeks: selectedWeeks };

        await setDoc(ref, { ...data, weeklyGoals }, { merge: true });
        await loadGoals(user);
        alert("Meta semanal salva.");
      } catch (error) {
        console.error("Erro ao salvar meta semanal:", error);
        alert("Erro ao salvar meta semanal.");
      }
    });

    clearGoalsBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      try {
        await setDoc(goalsDocRef(user.uid), { monthlyGoals: {}, weeklyGoals: {} });
        await loadGoals(user);
      } catch (error) {
        console.error("Erro ao limpar metas:", error);
      }
    });

    // ---------- DASHBOARD & CARREGAMENTO ----------
    let earningsChart;

    function setupChart(labels, values) {
      const ctx = document.getElementById("earningsChart").getContext("2d");
      if (earningsChart) earningsChart.destroy();
      earningsChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Ganhos",
              data: values,
              borderColor: "#22c55e",
              backgroundColor: "rgba(34,197,94,0.1)",
              tension: 0.3,
              fill: true,
              pointRadius: 3
            }
          ]
        },
        options: {
          scales: {
            x: {
              ticks: { color: "#94a3b8", font: { size: 10 } }
            },
            y: {
              ticks: {
                color: "#94a3b8",
                font: { size: 10 },
                callback: (v) => "R$ " + v
              }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    function getPeriodRange(period) {
      const now = new Date();
      const start = new Date();
      const end = new Date();

      if (period === "last7") {
        start.setDate(now.getDate() - 6);
      } else if (period === "month") {
        start.setDate(1);
      } else if (period === "year") {
        start.setMonth(0, 1);
      } else if (period === "prevMonth") {
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const firstDayPrev = new Date(currentYear, currentMonth - 1, 1);
        const lastDayPrev = new Date(currentYear, currentMonth, 0);
        return {
          start: firstDayPrev.toISOString().split("T")[0],
          end: lastDayPrev.toISOString().split("T")[0]
        };
      }
      return {
        start: start.toISOString().split("T")[0],
        end: end.toISOString().split("T")[0]
      };
    }

    periodButtons.forEach((btn) => {
      btn.addEventListener("click", async () => {
        periodButtons.forEach((b) => b.classList.remove("period-active"));
        btn.classList.add("period-active");
        const user = auth.currentUser;
        if (user) await loadDashboard(user, btn.dataset.period);
      });
    });

    async function loadDashboard(user, period = "last7") {
      const { start, end } = getPeriodRange(period);

      try {
        // Ganhos
        let earningsTotal = 0;
        let earningsCount = 0;
        const earningsByDay = {};
        const earningsQ = query(
          collection(db, "dailyEarnings"),
          where("userId", "==", user.uid),
          where("date", ">=", start),
          where("date", "<=", end),
          orderBy("date", "asc")
        );
        const earningsSnap = await getDocs(earningsQ);
        earningsSnap.forEach((docSnap) => {
          const data = docSnap.data();
          const amount = safeNumber(data.amount);
          const date = data.date;
          earningsTotal += amount;
          earningsCount += 1;
          earningsByDay[date] = (earningsByDay[date] || 0) + amount;
        });

        // Despesas trabalho
        let workTotal = 0;
        const workQ = query(
          collection(db, "expenses"),
          where("userId", "==", user.uid),
          where("date", ">=", start),
          where("date", "<=", end),
          orderBy("date", "asc")
        );
        const workSnap = await getDocs(workQ);
        workSnap.forEach((docSnap) => {
          workTotal += safeNumber(docSnap.data().amount);
        });

        // Despesas casa
        let houseTotal = 0;
        const houseQ = query(
          collection(db, "houseExpenses"),
          where("userId", "==", user.uid),
          where("date", ">=", start),
          where("date", "<=", end),
          orderBy("date", "asc")
        );
        const houseSnap = await getDocs(houseQ);
        houseSnap.forEach((docSnap) => {
          houseTotal += safeNumber(docSnap.data().amount);
        });

        const profit = earningsTotal - workTotal;
        const finalBalance = profit - houseTotal;
        const avgTicket = earningsCount > 0 ? earningsTotal / earningsCount : 0;
        const daysDiff =
          (new Date(end).getTime() - new Date(start).getTime()) / (1000 * 60 * 60 * 24) + 1;
        const costPerDay = daysDiff > 0 ? workTotal / daysDiff : 0;
        const margin = earningsTotal > 0 ? (profit / earningsTotal) * 100 : 0;

        totalEarningsDisplay.textContent = formatCurrency(earningsTotal);
        totalWorkExpensesDisplay.textContent = formatCurrency(workTotal);
        totalHouseExpensesDisplay.textContent = formatCurrency(houseTotal);
        profitDisplay.textContent = formatCurrency(profit);
        finalBalanceDisplay.textContent = formatCurrency(finalBalance);
        avgTicketDisplay.textContent = formatCurrency(avgTicket);
        costPerDayDisplay.textContent = formatCurrency(costPerDay);
        marginDisplay.textContent = formatPercent(margin);

        // gr√°fico m√™s completo (sempre do m√™s atual)
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth(); // 0-11
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0).getDate();

        const labels = [];
        const values = [];
        for (let d = 1; d <= lastDay; d++) {
          const dateObj = new Date(year, month, d);
          const key = dateObj.toISOString().split("T")[0];
          labels.push(d.toString());
          values.push(safeNumber(earningsByDay[key] || 0));
        }
        setupChart(labels, values);

        // meta di√°ria atual
        await loadGoals(user, { onlyUpdateDailyGoal: true });
      } catch (error) {
        console.error("Erro ao carregar dashboard:", error);
        if (error.code === "failed-precondition") {
          console.warn("Crie o √≠ndice sugerido pelo Firestore para dailyEarnings / expenses.");
        }
      }
    }

    async function loadEarningsList(user) {
      earningsList.innerHTML = "";
      try {
        const qE = query(
          collection(db, "dailyEarnings"),
          where("userId", "==", user.uid),
          orderBy("date", "desc")
        );
        const snap = await getDocs(qE);
        if (snap.empty) {
          earningsList.innerHTML =
            '<li class="text-slate-500 text-xs">Nenhum ganho cadastrado ainda.</li>';
          return;
        }
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const li = document.createElement("li");
          li.className =
            "flex justify-between items-center bg-slate-900/60 border border-slate-800 rounded-xl px-3 py-2";
          li.innerHTML = `
            <div>
              <p class="font-medium text-xs sm:text-sm">${formatCurrency(d.amount)} ‚Ä¢ ${
            d.platform || "Plataforma"
          }</p>
              <p class="text-[10px] text-slate-400">${d.date} ${
            d.notes ? "‚Ä¢ " + d.notes : ""
          }</p>
            </div>
          `;
          earningsList.appendChild(li);
        });
      } catch (error) {
        console.error("Erro ao carregar ganhos:", error);
      }
    }

    async function loadExpensesLists(user) {
      workExpensesList.innerHTML = "";
      houseExpensesList.innerHTML = "";

      // trabalho
      try {
        const qWork = query(
          collection(db, "expenses"),
          where("userId", "==", user.uid),
          orderBy("date", "desc")
        );
        const wSnap = await getDocs(qWork);
        if (wSnap.empty) {
          workExpensesList.innerHTML =
            '<li class="text-slate-500 text-xs">Nenhuma despesa de trabalho cadastrada.</li>';
        } else {
          wSnap.forEach((docSnap) => {
            const d = docSnap.data();
            const li = document.createElement("li");
            li.className =
              "flex justify-between items-center bg-slate-900/60 border border-slate-800 rounded-xl px-3 py-2";
            li.innerHTML = `
              <div>
                <p class="font-medium text-xs sm:text-sm">${formatCurrency(
                  d.amount
                )} ‚Ä¢ ${d.category}</p>
                <p class="text-[10px] text-slate-400">${d.date} ${
              d.description ? "‚Ä¢ " + d.description : ""
            }</p>
              </div>
            `;
            workExpensesList.appendChild(li);
          });
        }
      } catch (error) {
        console.error("Erro ao carregar despesas de trabalho:", error);
      }

      // casa
      try {
        const qHouse = query(
          collection(db, "houseExpenses"),
          where("userId", "==", user.uid),
          orderBy("date", "desc")
        );
        const hSnap = await getDocs(qHouse);
        if (hSnap.empty) {
          houseExpensesList.innerHTML =
            '<li class="text-slate-500 text-xs">Nenhuma despesa de casa cadastrada.</li>';
        } else {
          hSnap.forEach((docSnap) => {
            const d = docSnap.data();
            const li = document.createElement("li");
            li.className =
              "flex justify-between items-center bg-slate-900/60 border border-slate-800 rounded-xl px-3 py-2";
            li.innerHTML = `
              <div>
                <p class="font-medium text-xs sm:text-sm">${formatCurrency(
                  d.amount
                )} ‚Ä¢ ${d.category}</p>
                <p class="text-[10px] text-slate-400">${d.date} ${
              d.description ? "‚Ä¢ " + d.description : ""
            }</p>
              </div>
            `;
            houseExpensesList.appendChild(li);
          });
        }
      } catch (error) {
        console.error("Erro ao carregar despesas de casa:", error);
      }
    }

    async function loadGoals(user, options = {}) {
      const ref = goalsDocRef(user.uid);
      const snap = await getDoc(ref);
      let monthlyGoals = {};
      let weeklyGoals = {};

      if (snap.exists()) {
        const data = snap.data();
        monthlyGoals = data.monthlyGoals || {};
        weeklyGoals = data.weeklyGoals || {};
      }

      // Atualiza campos de meta (tela Metas)
      const currentMonthStr = new Date().toISOString().slice(0, 7); // yyyy-mm

      if (!options.onlyUpdateDailyGoal) {
        monthlyGoalMonth.value = currentMonthStr;
        weeklyGoalMonth.value = currentMonthStr;

        const monthValue = monthlyGoals[currentMonthStr] || 0;
        monthlyGoalValue.value = monthValue > 0 ? monthValue : "";

        // pega qualquer weeklyGoal do m√™s atual (se houver)
        const weeklyEntry = Object.entries(weeklyGoals).find(([key]) =>
          key.startsWith(currentMonthStr + "-")
        );
        if (weeklyEntry) {
          const [key, val] = weeklyEntry;
          weeklyGoalValue.value = val.value || "";
        } else {
          weeklyGoalValue.value = "";
        }
      }

      // calcula meta di√°ria
      let dailyGoal = 0;

      // prioridade para meta semanal se existir
      const weeklyForCurrent = Object.entries(weeklyGoals).find(([key]) =>
        key.startsWith(currentMonthStr + "-")
      );
      if (weeklyForCurrent) {
        const [key, val] = weeklyForCurrent;
        const weeks = val.weeks || [];
        const days = weeks.length * 7 || 1;
        dailyGoal = safeNumber(val.value) / days;
      } else if (monthlyGoals[currentMonthStr]) {
        const value = safeNumber(monthlyGoals[currentMonthStr]);
        const daysInMonth = new Date(
          new Date().getFullYear(),
          new Date().getMonth() + 1,
          0
        ).getDate();
        dailyGoal = value / daysInMonth;
      }

      currentDailyGoalDisplay.textContent = formatCurrency(dailyGoal);
      goalsCurrentDailyDisplay.textContent = formatCurrency(dailyGoal);
    }

    async function loadAllData(user) {
      await Promise.all([
        loadDashboard(user),
        loadEarningsList(user),
        loadExpensesLists(user),
        loadGoals(user)
      ]);
    }

    function initForUser(user) {
      periodButtons.forEach((b) => {
        b.classList.remove("period-active");
        if (b.dataset.period === "last7") b.classList.add("period-active");
      });
      loadAllData(user);
    }
  </script>
</body>
</html>
